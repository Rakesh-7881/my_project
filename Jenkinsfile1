pipeline {
    agent any
    environment {
        OUT_DIR = "out"
        APP_PORT = "9090"
    }
    stages {
        stage('Checkout') {
            steps {
                git branch: 'main', url: 'https://github.com/Rakesh-7881/my_project.git'
            }
        }
        stage('Compile') {
            steps {
                bat '''
                  if exist %OUT_DIR% rmdir /s /q %OUT_DIR%
                  mkdir %OUT_DIR%
                  javac -d %OUT_DIR% HelloJavaWeb.java
                '''
            }
        }
        stage('Deploy') {
            steps {
                powershell '''
                  Set-Location "C:\\ProgramData\\Jenkins\\.jenkins\\workspace\\Test"

                  # Kill old process on port 9090
                  Get-NetTCPConnection -LocalPort $env:APP_PORT -ErrorAction SilentlyContinue | ForEach-Object {
                      Stop-Process -Id $_.OwningProcess -Force
                  }

                  # Start new process
                  Start-Process java -ArgumentList "-cp", "out", "HelloJavaWeb", $env:APP_PORT -NoNewWindow

                  # Small wait
                  Start-Sleep -Seconds 5

                  Write-Output "Server started on http://localhost:$env:APP_PORT"
                '''
            }
        }
    }
}
